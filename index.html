<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿å›¾åº“</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <style>

        .album-actions .el-button {
            margin: 0 !important;

        }

        .action-buttons .el-button {
            margin: 0 !important;

        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .album-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .album-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .album-cover {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .album-info {
            padding: 15px;
        }

        .album-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .album-meta {
            font-size: 14px;
            color: #666;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .image-item {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
        }

        .image-thumb {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .back-button {
            margin-bottom: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .album-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .image-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-item:hover .image-actions,
        .image-actions.always-visible {
            opacity: 1;
        }

        .action-button {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .image-detail-layout {
            display: flex;
            height: calc(100vh - 100px);
            gap: 0;
            box-shadow: 0 2px 6px 0 rgba(0, 0, 0, 0.1);
        }

        .image-section {
            flex: 7;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        .nav-button {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #409eff;
            color: #409eff;
            font-size: 18px;
            z-index: 10;
        }

        .nav-button.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: #ccc;
            color: #ccc;
        }

        .image-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            max-width: calc(100% - 120px);
            height: 100%;
        }

        .detail-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .info-section {
            flex: 3;
            min-width: 300px;
            background: white;
            border-left: 1px solid #e0e0e0;
            overflow-y: auto;
        }

        .info-panel {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .info-content {
            flex: 1;
        }

        .info-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
            line-height: 1.5;
            font-size: 14px;
            word-break: break-all; /* æ·»åŠ è¿™ä¸€è¡Œ */
        }

        .action-buttons {
            /*margin: 20px 0;*/
            display: flex;
            flex-direction: column;
            gap: 10px;
        }


        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .header h1 {
                font-size: 1.5rem;
                text-align: center;
            }

            .album-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .album-cover {
                height: 150px;
            }

            .album-info {
                padding: 10px;
            }

            .album-name {
                font-size: 16px;
            }

            .album-meta {
                font-size: 12px;
            }

            .image-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
            }

            .album-actions {
                flex-direction: column;
            }

            .image-detail-layout {
                flex-direction: column;
                height: auto;
            }

            .image-section {
                flex: none;
                height: 60vh;
                padding: 10px;
            }

            .nav-button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .image-container {
                max-width: calc(100% - 100px);
            }

            .info-section {
                flex: none;
                min-width: auto;
                border-left: none;
                border-top: 1px solid #e0e0e0;
            }

            .info-panel {
                padding: 15px;
            }

            .el-dialog {
                width: 95% !important;
                max-width: 95% !important;
            }

        }

        @media (max-width: 480px) {
            .album-grid {
                grid-template-columns: 1fr;
            }

            .image-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .thumbnails {
                grid-template-columns: repeat(3, 1fr);
            }
        }


        /*floatingstart*/
        .floating-toolbar {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid #e0e0e0;
            z-index: 100;
        }

        .floating-toolbar .el-button {
            width: 45px;
            height: 45px;
            font-size: 18px;
        }

        .floating-toolbar .el-button .el-icon {
            font-size: 20px;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .floating-toolbar {
                bottom: 20px;
                padding: 10px 16px;
                gap: 12px;
            }

            .floating-toolbar .el-button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .floating-toolbar .el-button .el-icon {
                font-size: 18px;
            }
        }

        /*floatingend*/

    </style>
</head>
<body>
<div id="app">
    <div class="container">
        <!-- ç›¸å†Œåˆ—è¡¨é¡µé¢ -->
        <div v-if="currentView === 'albums'">
            <div class="header">
                <h1>æˆ‘çš„ç›¸å†Œ</h1>
                <el-button type="primary" @click="showCreateAlbumDialog = true">æ–°å»ºç›¸å†Œ</el-button>
            </div>

            <div v-if="albums.length === 0" class="empty-state">
                <p>è¿˜æ²¡æœ‰ç›¸å†Œï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼</p>
            </div>

            <div class="album-grid" v-else>
                <div v-for="album in albums" :key="album.id" class="album-card" @click="openAlbum(album.id)">
                    <img v-if="album.cover_filename" :src="`/api/images/${album.cover_image_id}/file?type=thumbnail`"
                         :alt="album.name" class="album-cover">
                    <div v-else class="album-cover"
                         style="display: flex; align-items: center; justify-content: center;">
                        <span>æš‚æ— å°é¢</span>
                    </div>
                    <div class="album-info">
                        <div class="album-name">{{ album.name }}</div>
                        <div class="album-meta">
                            <div>å›¾ç‰‡: {{ getAlbumImageCount(album.id) }}</div>
                            <div>åˆ›å»º: {{ formatDate(album.created_at) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç›¸å†Œè¯¦æƒ…é¡µé¢ -->
        <div v-if="currentView === 'album-detail'">
            <div class="back-button">
                <el-button @click="backToAlbums">è¿”å›ç›¸å†Œåˆ—è¡¨</el-button>
            </div>

            <div class="header">
                <h1>{{ currentAlbum.name }}</h1>
                <div class="album-actions">
                    <el-button @click="showEditAlbumDialog = true">ç¼–è¾‘ç›¸å†Œ</el-button>
                    <el-button @click="showUploadDialog = true">ä¸Šä¼ å›¾ç‰‡</el-button>
                    <el-button type="danger" @click="deleteAlbum(currentAlbum.id)">åˆ é™¤ç›¸å†Œ</el-button>
                </div>
            </div>

            <div class="album-meta" style="margin-bottom: 20px;">
                <p v-if="currentAlbum.shoot_date"><strong>æ‹æ‘„æ—¥æœŸ:</strong> {{ formatDate(currentAlbum.shoot_date) }}
                </p>
                <p v-if="currentAlbum.model_name"><strong>æ¨¡ç‰¹:</strong> {{ currentAlbum.model_name }}</p>
                <p v-if="currentAlbum.location"><strong>åœ°ç‚¹:</strong> {{ currentAlbum.location }}</p>
            </div>

            <div v-if="images.length === 0" class="empty-state">
                <p>è¿™ä¸ªç›¸å†Œè¿˜æ²¡æœ‰å›¾ç‰‡ï¼Œä¸Šä¼ ä¸€äº›å§ï¼</p>
            </div>

            <div class="image-grid" v-else>
                <div v-for="image in images" :key="image.id" class="image-item" @click="viewImage(image.id)">
                    <img :src="`/api/images/${image.id}/file?type=thumbnail`" :alt="image.original_filename"
                         class="image-thumb">
                    <div class="image-actions" :class="{ 'always-visible': image.is_favorited }">

                        <button
                                class="action-button"
                                :class="{ 'favorited': image.is_favorited }"
                                @click.stop="toggleFavorite(image.id)"
                                :title="image.is_favorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'"
                        >
                            {{ image.is_favorited ? 'â­' : 'â˜†' }}
                        </button>
                        <!--                        <button class="action-button" @click.stop="setAsCover(image.id)" title="è®¾ä¸ºå°é¢">â­</button>-->
                        <button class="action-button" @click.stop="deleteImage(image.id)" title="åˆ é™¤å›¾ç‰‡">ğŸ—‘ï¸</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡è¯¦æƒ…é¡µé¢ -->
        <div v-if="currentView === 'image-detail'">
            <div class="back-button">
                <el-button @click="backToAlbum">è¿”å›ç›¸å†Œ</el-button>
            </div>

            <div class="image-detail-layout">
                <div class="image-section">
                    <div class="nav-button prev-button" :class="{ disabled: !hasPrev }" @click="prevImage">â†</div>
                    <div class="image-container">
                        <img :src="`/api/images/${currentImage.id}/file?type=compressed`"
                             :alt="currentImage.original_filename" class="detail-image"/>
                    </div>
                    <div class="nav-button next-button" :class="{ disabled: !hasNext }" @click="nextImage">â†’</div>


                    <!-- æ‚¬æµ®å·¥å…·çª— -->
                    <div class="floating-toolbar">
                        <el-button
                                circle
                                :type="currentImage.is_favorited ? 'primary' : 'default'"
                                @click="toggleFavorite(currentImage.id)"
                                :title="currentImage.is_favorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'"
                        >
                            ğŸŒŸ
                        </el-button>
                        <el-button
                                circle
                                type="danger"
                                @click="deleteImage(currentImage.id)"
                                title="åˆ é™¤å›¾ç‰‡"
                        >
                            ğŸ—‘ï¸
                        </el-button>
                    </div>


                </div>

                <div class="info-section">
                    <div class="info-panel">
                        <h3>å›¾ç‰‡ä¿¡æ¯</h3>
                        <div class="info-content" style="margin-top:30px">


                            <!--                            <div class="info-item"><strong>æ–‡ä»¶å:</strong> {{ currentImage.original_filename }}</div>-->

                            <div class="info-item">
                                <strong>æ–‡ä»¶å: </strong><!--æ˜¾ç¤ºè¾“å…¥æ¡†åè‡ªåŠ¨è·å¾—ç„¦ç‚¹-->
                                <span class="filename-display" v-if="!renamingFile"
                                      @dblclick="startRename">{{ currentImage.original_filename}}
                                    <!--                                    <el-button type="text" size="small"  >Edit</el-button>-->
                                </span>
                                <el-input v-else v-model="newFilename" size="small"
                                          style="width: 200px; margin-left: 8px;" @keyup.enter="confirmRename"
                                          @keyup.esc="cancelRename"
                                          @blur="cancelRename"/>
                            </div>


                            <div class="info-item"><strong>æ–‡ä»¶å¤§å°:</strong> {{ formatFileSize(currentImage.file_size)
                                }}
                            </div>
                            <div class="info-item"><strong>å°ºå¯¸:</strong> {{ currentImage.width }} Ã—
                                {{ currentImage.height }}
                            </div>
                            <div class="info-item"><strong>ä¸Šä¼ æ—¶é—´:</strong> {{ formatDate(currentImage.uploaded_at) }}
                            </div>
                            <div class="info-item"><strong>å½“å‰ä½ç½®:</strong> {{ currentImageIndex + 1 }} /
                                {{ images.length }}
                            </div>
                        </div>


                        <div class="action-buttons">
                            <el-button type="primary" @click="downloadImage(currentImage.id)">ä¸‹è½½åŸå›¾</el-button>
                            <el-button type="primary" @click="setAsCover(currentImage.id)">è®¾ä¸ºå°é¢</el-button>


                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- å¯¹è¯æ¡† -->
        <el-dialog v-model="showCreateAlbumDialog" title="æ–°å»ºç›¸å†Œ">
            <el-form :model="newAlbum">
                <el-form-item label="ç›¸å†Œåç§°">
                    <el-input v-model="newAlbum.name" placeholder="è¯·è¾“å…¥ç›¸å†Œåç§°"></el-input>
                </el-form-item>
                <el-form-item label="æ‹æ‘„æ—¥æœŸ">
                    <el-date-picker v-model="newAlbum.shoot_date" type="date"
                                    placeholder="é€‰æ‹©æ‹æ‘„æ—¥æœŸ"></el-date-picker>
                </el-form-item>
                <el-form-item label="æ¨¡ç‰¹">
                    <el-input v-model="newAlbum.model_name" placeholder="è¯·è¾“å…¥æ¨¡ç‰¹åå­—"></el-input>
                </el-form-item>
                <el-form-item label="åœ°ç‚¹">
                    <el-input v-model="newAlbum.location" placeholder="è¯·è¾“å…¥æ‹æ‘„åœ°ç‚¹"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showCreateAlbumDialog = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="createAlbum">åˆ›å»º</el-button>
            </template>
        </el-dialog>

        <el-dialog v-model="showEditAlbumDialog" title="ç¼–è¾‘ç›¸å†Œ">
            <el-form :model="currentAlbum">
                <el-form-item label="ç›¸å†Œåç§°">
                    <el-input v-model="currentAlbum.name" placeholder="è¯·è¾“å…¥ç›¸å†Œåç§°"></el-input>
                </el-form-item>
                <el-form-item label="æ‹æ‘„æ—¥æœŸ">
                    <el-date-picker v-model="currentAlbum.shoot_date" type="date"
                                    placeholder="é€‰æ‹©æ‹æ‘„æ—¥æœŸ"></el-date-picker>
                </el-form-item>
                <el-form-item label="æ¨¡ç‰¹">
                    <el-input v-model="currentAlbum.model_name" placeholder="è¯·è¾“å…¥æ¨¡ç‰¹åå­—"></el-input>
                </el-form-item>
                <el-form-item label="åœ°ç‚¹">
                    <el-input v-model="currentAlbum.location" placeholder="è¯·è¾“å…¥æ‹æ‘„åœ°ç‚¹"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showEditAlbumDialog = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="updateAlbum">ä¿å­˜</el-button>
            </template>
        </el-dialog>

        <el-dialog v-model="showUploadDialog" title="ä¸Šä¼ å›¾ç‰‡">
            <el-upload drag multiple :action="`/api/albums/${currentAlbum.id}/images`" :on-success="handleUploadSuccess"
                       :on-error="handleUploadError" :before-upload="beforeUpload">
                <div class="el-upload__text">å°†æ–‡ä»¶æ‹–åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em></div>
                <template #tip>
                    <div class="el-upload__tip">åªèƒ½ä¸Šä¼ jpg/pngæ–‡ä»¶</div>
                </template>
            </el-upload>
            <template #footer>
                <el-button @click="showUploadDialog = false">å…³é—­</el-button>
            </template>
        </el-dialog>
    </div>
</div>

<script>
    const {createApp, ref, onMounted, computed} = Vue;
    const {ElMessage, ElMessageBox} = ElementPlus;

    createApp({
        setup() {

            const currentView = ref('albums');
            const albums = ref([]);
            const images = ref([]);
            const currentAlbum = ref({});
            const currentImage = ref({});


            const showCreateAlbumDialog = ref(false);
            const showEditAlbumDialog = ref(false);
            const showUploadDialog = ref(false);

            const newAlbum = ref({
                name: '',
                shoot_date: '',
                model_name: '',
                location: '',
            });

            const currentImageIndex = computed(() => {
                return images.value.findIndex(img => img.id === currentImage.value.id);
            });

            const hasPrev = computed(() => currentImageIndex.value > 0);
            const hasNext = computed(() => currentImageIndex.value < images.value.length - 1);

            // const getAlbumImageCount = (albumId) => {
            //     // ç®€åŒ–å®ç°ï¼Œå®é™…åº”è¯¥ä»åç«¯è·å–
            //     return images.value.filter(img => img.album_id === albumId).length;
            // };

            const getAlbumImageCount = (albumId) => {
                const album = albums.value.find(a => a.id === albumId);
                return album ? album.image_count : 0;
            };

            const loadAlbums = async () => {
                try {
                    const response = await fetch('/api/albums');
                    albums.value = await response.json();
                } catch (error) {
                    ElMessage.error('åŠ è½½ç›¸å†Œå¤±è´¥');
                }
            };

            const loadAlbumImages = async (albumId) => {
                try {
                    const response = await fetch(`/api/albums/${albumId}/images`);
                    images.value = await response.json();
                } catch (error) {
                    ElMessage.error('åŠ è½½å›¾ç‰‡å¤±è´¥');
                }
            };

            const createAlbum = async () => {
                if (!newAlbum.value.name) {
                    ElMessage.warning('è¯·è¾“å…¥ç›¸å†Œåç§°');
                    return;
                }
                try {
                    const response = await fetch('/api/albums', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(newAlbum.value)
                    });
                    if (response.ok) {
                        ElMessage.success('ç›¸å†Œåˆ›å»ºæˆåŠŸ');
                        showCreateAlbumDialog.value = false;
                        newAlbum.value = {
                            name: '',
                            description: '',
                            shoot_date: '',
                            model_name: '',
                            weather: '',
                            equipment: ''
                        };
                        loadAlbums();
                    }
                } catch (error) {
                    ElMessage.error('åˆ›å»ºç›¸å†Œå¤±è´¥');
                }
            };

            const updateAlbum = async () => {
                try {
                    const response = await fetch(`/api/albums/${currentAlbum.value.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(currentAlbum.value)
                    });
                    if (response.ok) {
                        ElMessage.success('ç›¸å†Œæ›´æ–°æˆåŠŸ');
                        showEditAlbumDialog.value = false;
                        loadAlbums();
                    }
                } catch (error) {
                    ElMessage.error('æ›´æ–°ç›¸å†Œå¤±è´¥');
                }
            };

            const deleteAlbum = async (albumId) => {
                try {
                    await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›¸å†Œå—ï¼Ÿç›¸å†Œä¸­çš„æ‰€æœ‰å›¾ç‰‡ä¹Ÿå°†è¢«åˆ é™¤ã€‚', 'è­¦å‘Š', {
                        confirmButtonText: 'ç¡®å®š', cancelButtonText: 'å–æ¶ˆ', type: 'warning'
                    });
                    const response = await fetch(`/api/albums/${albumId}`, {method: 'DELETE'});
                    if (response.ok) {
                        ElMessage.success('ç›¸å†Œåˆ é™¤æˆåŠŸ');
                        backToAlbums();
                        loadAlbums();
                    }
                } catch (error) {
                    if (error !== 'cancel') ElMessage.error('åˆ é™¤ç›¸å†Œå¤±è´¥');
                }
            };

            const openAlbum = async (albumId) => {
                const album = albums.value.find(a => a.id === albumId);
                if (album) {
                    currentAlbum.value = {...album};
                    await loadAlbumImages(albumId);
                    currentView.value = 'album-detail';
                }
            };

            const backToAlbums = () => {
                currentView.value = 'albums';
                currentAlbum.value = {};
                images.value = [];
            };

            const backToAlbum = () => {
                currentView.value = 'album-detail';
                currentImage.value = {};
            };

            const viewImage = (imageId) => {
                const image = images.value.find(img => img.id === imageId);
                if (image) {
                    currentImage.value = image;
                    currentView.value = 'image-detail';
                }
            };

            const prevImage = () => {
                if (hasPrev.value) {
                    currentImage.value = images.value[currentImageIndex.value - 1];
                } else {
                    ElMessage.info('å·²ç»æ˜¯ç¬¬ä¸€å¼ å›¾ç‰‡äº†');
                }
            };

            const nextImage = () => {
                if (hasNext.value) {
                    currentImage.value = images.value[currentImageIndex.value + 1];
                } else {
                    ElMessage.info('å·²ç»æ˜¯æœ€åä¸€å¼ å›¾ç‰‡äº†');
                }
            };

            const handleUploadSuccess = () => {
                ElMessage.success('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
                loadAlbumImages(currentAlbum.value.id);
            };

            const handleUploadError = () => {
                ElMessage.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
            };

            const beforeUpload = (file) => {
                // const isJPGOrPNG = file.type === 'image/jpeg' || file.type === 'image/png';
                // const isLt10M = file.size / 1024 / 1024 < 10;
                // if (!isJPGOrPNG) ElMessage.error('åªèƒ½ä¸Šä¼ JPG/PNGæ ¼å¼çš„å›¾ç‰‡!');
                // if (!isLt10M) ElMessage.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB!');
                // return isJPGOrPNG && isLt10M;
            };

            const deleteImage = async (imageId) => {
                try {
                    await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ', 'è­¦å‘Š', {
                        confirmButtonText: 'ç¡®å®š', cancelButtonText: 'å–æ¶ˆ', type: 'warning'
                    });
                    const response = await fetch(`/api/images/${imageId}`, {method: 'DELETE'});
                    if (response.ok) {
                        ElMessage.success('å›¾ç‰‡åˆ é™¤æˆåŠŸ');
                        loadAlbumImages(currentAlbum.value.id);
                        if (currentAlbum.value.cover_image_id === imageId) loadAlbums();
                    }
                } catch (error) {
                    if (error !== 'cancel') ElMessage.error('åˆ é™¤å›¾ç‰‡å¤±è´¥');
                }
            };

            const setAsCover = async (imageId) => {
                try {
                    const response = await fetch(`/api/albums/${currentAlbum.value.id}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({cover_image_id: imageId})
                    });
                    if (response.ok) {
                        ElMessage.success('å°é¢è®¾ç½®æˆåŠŸ');
                        currentAlbum.value.cover_image_id = imageId;
                        loadAlbums();
                    }
                } catch (error) {
                    ElMessage.error('è®¾ç½®å°é¢å¤±è´¥');
                }
            };

            const downloadImage = async (imageId) => {
                try {
                    const response = await fetch(`/api/images/${imageId}/file?type=original`);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = currentImage.value.original_filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } catch (error) {
                    ElMessage.error('ä¸‹è½½å›¾ç‰‡å¤±è´¥');
                }
            };

            const formatDate = (dateString) => {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('zh-CN');
            };

            const formatFileSize = (bytes) => {
                if (!bytes) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };

            onMounted(() => {
                loadAlbums();
            });


            //rename start
            // æ·»åŠ çŠ¶æ€
            const renamingFile = ref(false);
            const newFilename = ref('');


// å¼€å§‹é‡å‘½å
            const startRename = () => {
                newFilename.value = currentImage.value.original_filename;
                renamingFile.value = true;

            }

// ç¡®è®¤é‡å‘½å
            const confirmRename = async () => {
                if (!newFilename.value.trim()) {
                    ElMessage.warning('æ–‡ä»¶åä¸èƒ½ä¸ºç©º');
                    return;
                }

                if (newFilename.value === currentImage.value.original_filename) {
                    renamingFile.value = false;
                    return;
                }

                try {
                    const response = await fetch(`/api/images/${currentImage.value.id}/rename`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            new_filename: newFilename.value
                        })
                    });

                    if (response.ok) {
                        ElMessage.success('é‡å‘½åæˆåŠŸ');
                        currentImage.value.original_filename = newFilename.value;
                        renamingFile.value = false;
                    } else {
                        const data = await response.json();
                        ElMessage.error(data.error || 'é‡å‘½åå¤±è´¥');
                    }
                } catch (error) {
                    ElMessage.error('é‡å‘½åå¤±è´¥');
                }
            };

// å–æ¶ˆé‡å‘½å
            const cancelRename = () => {
                renamingFile.value = false;
                newFilename.value = '';
            };

// rename end


            //favourtie start
// æ·»åŠ æ”¶è—çŠ¶æ€ç®¡ç†
            const toggleFavorite = async (imageId) => {
                try {
                    const response = await fetch(`/api/images/${imageId}/favorite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // æ›´æ–°æœ¬åœ°çŠ¶æ€
                        const imageIndex = images.value.findIndex(img => img.id === imageId);
                        if (imageIndex !== -1) {
                            images.value[imageIndex].is_favorited = data.is_favorited;
                        }
                        // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹çš„å›¾ç‰‡è¢«æ”¶è—/å–æ¶ˆæ”¶è—ï¼Œä¹Ÿæ›´æ–°å½“å‰å›¾ç‰‡çŠ¶æ€
                        if (currentImage.value && currentImage.value.id === imageId) {
                            currentImage.value.is_favorited = data.is_favorited;
                        }

                        ElMessage.success(data.is_favorited ? 'æ”¶è—æˆåŠŸ' : 'å–æ¶ˆæ”¶è—');
                    }
                } catch (error) {
                    ElMessage.error('æ“ä½œå¤±è´¥');
                }
            };

// fav end


            return {
                currentView, albums, images, currentAlbum, currentImage,
                showCreateAlbumDialog, showEditAlbumDialog, showUploadDialog,
                newAlbum, currentImageIndex, hasPrev, hasNext,
                getAlbumImageCount, loadAlbums, loadAlbumImages, createAlbum, updateAlbum,
                deleteAlbum, openAlbum, backToAlbums, backToAlbum, viewImage,
                prevImage, nextImage, handleUploadSuccess, handleUploadError,
                beforeUpload, deleteImage, setAsCover, downloadImage,
                formatDate, formatFileSize, renamingFile,
                newFilename,
                startRename,
                confirmRename,
                cancelRename, toggleFavorite,


            };
        }
    }).use(ElementPlus).mount('#app');
</script>
</body>
</html>